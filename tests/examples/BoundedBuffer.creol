interface BufferA
begin with Producer
  op append(in d: Data)
end

interface BufferR
begin with Consumer
  op remove(out d: Data)
end

interface Buffer inherits BufferA, BufferR
begin 
end

class BoundedBuffer implements Buffer
begin 
  var buffer: List[Data] := nil
  var max: Int := 10
  var n: Int := 0

  op init == skip
  op run == skip

  with Producer
    op append(in d:Data) == await n < max; buffer := buffer |- d
  with Consumer
    op remove(out d:Data) ==
      await n > 0; d := head(buffer); buffer := tail(buffer)
end


interface Consumer
begin
end

interface Producer
begin 
end

class Producer(b: BufferA)
  contracts Producer
begin
  op init == skip
  op run == !loop(0)
  op loop(in i: Int) == b.append(i;); !loop(i+1)
end


class Consumer (b: BufferR)
  contracts Consumer
begin
  op init == skip
  op run == var y:Data; b.remove(;y); !run()
end

class Starter
begin
  op init == skip
  op run == var b: Buffer; var p: Producer; var c: Consumer; 
            b := new BoundedBuffer(); 
            p := new Producer(b);
            c := new Consumer(b)
end
